package inventory;

import javax.swing.*;
import javax.swing.table.*;
import java.awt.*;
import java.io.FileWriter;
import java.sql.*;

public class InventoryApp extends JFrame {

    private JTextField nameField, qtyField, priceField, searchField;
    private JTable table;
    private DefaultTableModel model;
    private JComboBox<CategoryItem> categoryBox, filterCategoryBox;
    private int lowStockThreshold = 5;

    private static final String URL = "jdbc:mysql://localhost:3306/inventory_db";
    private static final String USER = "root";
    private static final String PASSWORD = "Harshit4204#";

    // ================= CATEGORY ITEM =================
    static class CategoryItem {
        int id;
        String name;
        boolean placeholder;

        CategoryItem(int id, String name, boolean placeholder) {
            this.id = id;
            this.name = name;
            this.placeholder = placeholder;
        }

        public String toString() {
            return name;
        }
    }

    // ================= CONSTRUCTOR =================
    public InventoryApp() {
        setTitle("Smart Inventory Management System");
        setSize(1100, 600);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setLayout(new BorderLayout(10, 10));

        loadThreshold();

        // ---------- TOP PANEL ----------
        JPanel topPanel = new JPanel();
        topPanel.setLayout(new BoxLayout(topPanel, BoxLayout.Y_AXIS));

        // ---------- PRODUCT FORM ----------
        JPanel formPanel = new JPanel(new GridLayout(2, 4, 10, 10));
        formPanel.setBorder(BorderFactory.createTitledBorder("Product Details"));

        nameField = new JTextField();
        qtyField = new JTextField();
        priceField = new JTextField();
        categoryBox = new JComboBox<>();

        categoryBox.addItem(new CategoryItem(-1, "Select Category", true));
        loadCategories(categoryBox);

        formPanel.add(new JLabel("Product Name"));
        formPanel.add(new JLabel("Quantity"));
        formPanel.add(new JLabel("Price"));
        formPanel.add(new JLabel("Category"));

        formPanel.add(nameField);
        formPanel.add(qtyField);
        formPanel.add(priceField);
        formPanel.add(categoryBox);

        // ---------- ACTION BUTTONS ----------
        JPanel actionPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 10, 5));
        JButton addBtn = new JButton("Add");
        JButton updateBtn = new JButton("Update Qty");
        JButton deleteBtn = new JButton("Delete");
        JButton exportBtn = new JButton("Export CSV");
        JButton thresholdBtn = new JButton("Set Threshold");

        actionPanel.add(addBtn);
        actionPanel.add(updateBtn);
        actionPanel.add(deleteBtn);
        actionPanel.add(exportBtn);
        actionPanel.add(thresholdBtn);

        // ---------- FILTER + SEARCH ----------
        JPanel filterPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));

        filterCategoryBox = new JComboBox<>();
        filterCategoryBox.addItem(new CategoryItem(-1, "All Categories", true));
        loadCategories(filterCategoryBox);

        searchField = new JTextField(15);

        filterPanel.add(new JLabel("Filter:"));
        filterPanel.add(filterCategoryBox);
        filterPanel.add(new JLabel("Search:"));
        filterPanel.add(searchField);

        topPanel.add(formPanel);
        topPanel.add(actionPanel);
        topPanel.add(filterPanel);

        add(topPanel, BorderLayout.NORTH);

        // ---------- TABLE ----------
        model = new DefaultTableModel(
                new String[]{"ID", "Name", "Category", "Quantity", "Price", "Status"}, 0
        );
        table = new JTable(model);
        table.setRowHeight(25);
        table.setDefaultRenderer(Object.class, new StockRenderer());
        add(new JScrollPane(table), BorderLayout.CENTER);

        // ---------- ACTION LISTENERS ----------
        addBtn.addActionListener(e -> addProduct());
        updateBtn.addActionListener(e -> updateQuantity());
        deleteBtn.addActionListener(e -> deleteProduct());
        exportBtn.addActionListener(e -> exportCSV());
        thresholdBtn.addActionListener(e -> setThreshold());
        searchField.addActionListener(e -> applyFilters());
        filterCategoryBox.addActionListener(e -> applyFilters());

        loadData();
        setVisible(true);
    }

    // ================= DB =================
    private Connection connect() throws Exception {
        Class.forName("com.mysql.cj.jdbc.Driver");
        return DriverManager.getConnection(URL, USER, PASSWORD);
    }

    // ================= LOAD THRESHOLD =================
    private void loadThreshold() {
        try (Connection c = connect();
             Statement s = c.createStatement();
             ResultSet r = s.executeQuery("SELECT low_stock_threshold FROM settings WHERE id=1")) {
            if (r.next()) lowStockThreshold = r.getInt(1);
        } catch (Exception e) {
            lowStockThreshold = 5;
        }
    }

    private void setThreshold() {
        String val = JOptionPane.showInputDialog(this, "Enter low stock threshold:", lowStockThreshold);
        if (val == null) return;

        try {
            int t = Integer.parseInt(val);
            try (Connection c = connect();
                 PreparedStatement ps = c.prepareStatement(
                         "UPDATE settings SET low_stock_threshold=? WHERE id=1")) {
                ps.setInt(1, t);
                ps.executeUpdate();
                lowStockThreshold = t;
                loadData();
            }
        } catch (Exception ignored) {}
    }

    // ================= CATEGORY =================
    private void loadCategories(JComboBox<CategoryItem> box) {
        try (Connection c = connect();
             Statement s = c.createStatement();
             ResultSet r = s.executeQuery("SELECT * FROM categories")) {
            while (r.next()) {
                box.addItem(new CategoryItem(r.getInt(1), r.getString(2), false));
            }
        } catch (Exception ignored) {}
    }

    // ================= CRUD =================
    private void addProduct() {
        CategoryItem cat = (CategoryItem) categoryBox.getSelectedItem();
        if (cat.placeholder) return;

        try (Connection c = connect();
             PreparedStatement ps = c.prepareStatement(
                     "INSERT INTO products(name,category_id,quantity,price) VALUES (?,?,?,?)")) {
            ps.setString(1, nameField.getText());
            ps.setInt(2, cat.id);
            ps.setInt(3, Integer.parseInt(qtyField.getText()));
            ps.setDouble(4, Double.parseDouble(priceField.getText()));
            ps.executeUpdate();
            loadData();
        } catch (Exception ignored) {}
    }

    private void updateQuantity() {
        int r = table.getSelectedRow();
        if (r == -1) return;

        int id = (int) model.getValueAt(r, 0);
        try (Connection c = connect();
             PreparedStatement ps = c.prepareStatement(
                     "UPDATE products SET quantity=? WHERE product_id=?")) {
            ps.setInt(1, Integer.parseInt(qtyField.getText()));
            ps.setInt(2, id);
            ps.executeUpdate();
            loadData();
        } catch (Exception ignored) {}
    }

    private void deleteProduct() {
        int r = table.getSelectedRow();
        if (r == -1) return;

        try (Connection c = connect();
             PreparedStatement ps = c.prepareStatement(
                     "DELETE FROM products WHERE product_id=?")) {
            ps.setInt(1, (int) model.getValueAt(r, 0));
            ps.executeUpdate();
            loadData();
        } catch (Exception ignored) {}
    }

    // ================= LOAD + FILTER =================
    private void loadData() {
        model.setRowCount(0);
        try (Connection c = connect();
             Statement s = c.createStatement();
             ResultSet r = s.executeQuery("""
                SELECT p.product_id,p.name,c.name,p.quantity,p.price
                FROM products p JOIN categories c ON p.category_id=c.category_id
             """)) {
            while (r.next()) {
                int q = r.getInt(4);
                model.addRow(new Object[]{
                        r.getInt(1), r.getString(2), r.getString(3),
                        q, r.getDouble(5),
                        q < lowStockThreshold ? "LOW" : "OK"
                });
            }
        } catch (Exception ignored) {}
    }

    private void applyFilters() {
        model.setRowCount(0);
        CategoryItem cat = (CategoryItem) filterCategoryBox.getSelectedItem();

        String sql = """
            SELECT p.product_id,p.name,c.name,p.quantity,p.price
            FROM products p JOIN categories c ON p.category_id=c.category_id
            WHERE p.name LIKE ?
        """ + (cat.placeholder ? "" : " AND c.category_id=?");

        try (Connection c = connect();
             PreparedStatement ps = c.prepareStatement(sql)) {

            ps.setString(1, "%" + searchField.getText() + "%");
            if (!cat.placeholder) ps.setInt(2, cat.id);

            ResultSet r = ps.executeQuery();
            while (r.next()) {
                int q = r.getInt(4);
                model.addRow(new Object[]{
                        r.getInt(1), r.getString(2), r.getString(3),
                        q, r.getDouble(5),
                        q < lowStockThreshold ? "LOW" : "OK"
                });
            }
        } catch (Exception ignored) {}
    }

    // ================= CSV EXPORT =================
    private void exportCSV() {
        try (FileWriter fw = new FileWriter("inventory_export.csv")) {
            for (int i = 0; i < model.getColumnCount(); i++)
                fw.append(model.getColumnName(i)).append(",");
            fw.append("\n");

            for (int r = 0; r < model.getRowCount(); r++) {
                for (int c = 0; c < model.getColumnCount(); c++)
                    fw.append(model.getValueAt(r, c).toString()).append(",");
                fw.append("\n");
            }
            JOptionPane.showMessageDialog(this, "Exported to inventory_export.csv");
        } catch (Exception ignored) {}
    }

    // ================= ROW COLOR =================
    class StockRenderer extends DefaultTableCellRenderer {
        public Component getTableCellRendererComponent(
                JTable t, Object v, boolean s, boolean f, int r, int c) {

            Component cell = super.getTableCellRendererComponent(t, v, s, f, r, c);
            int qty = (int) t.getValueAt(r, 3);

            cell.setBackground(qty < lowStockThreshold ? new Color(255, 180, 180) : Color.WHITE);
            return cell;
        }
    }

    // ================= MAIN =================
    public static void main(String[] args) {
        SwingUtilities.invokeLater(InventoryApp::new);
    }
}
